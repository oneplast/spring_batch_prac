<html layout:decorate="~{global/usrLayout}">

<head>
    <title>주문 [[${order.id}]]번</title>

    <script src="https://js.tosspayments.com/v2/standard"></script>

    <script th:inline="javascript">
        const orderId = /*[[ ${order.id} ]]*/ null;
        const dateOrderId =
            /*[[ ${order.id != null
                    ? #temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd') + '__' + order.id
                    : null} ]]*/ null;
        const buyerName = "홍길동";
        const buyerUsername = /*[[ ${order.buyer.username} ]]*/ null;
        const orderName = "책 N권";
        const actorRestCash = /*[[ ${actorRestCash} ]]*/ null;
        const orderPayPrice = /*[[ ${order.calcPayPrice} ]]*/ null;
        const toss_clientKey = /*[[ ${@environment.getProperty('custom.toss-payments.widget.client-key')} ]]*/ null;
    </script>
</head>

<body>

<div layout:fragment="content">

    <!-- 결제 UI -->
    <div id="payment-method"></div>

    <!-- 이용약관 UI -->
    <div id="agreement"></div>

    <!-- 결제하기 버튼 -->
    <div class="result wrapper">
        <button class="button" id="payment-button" style="margin-top: 30px">
            결제하기
        </button>
    </div>

    <script>

        (async () => {
            const button = document.getElementById("payment-button");
            const generateRandomString = () => window.btoa(Math.random()).slice(0, 20);

            const clientKey = toss_clientKey;
            const tossPayments = TossPayments(clientKey);
            const customerKey = buyerUsername;
            var amount = orderPayPrice;

            const widgets = tossPayments.widgets({customerKey});

            await widgets.setAmount({
                currency: "KRW",
                value: amount,
            })

            await widgets.renderPaymentMethods({
                selector: "#payment-method",
                variantKey: "DEFAULT",
            });

            await widgets.renderAgreement({
                selector: "#agreement",
                variantKey: "AGREEMENT",
            });

            button.addEventListener("click", async function () {
                await widgets.requestPayment({
                    orderId: dateOrderId,
                    orderName: orderName,
                    successUrl: window.location.origin + "/order/success",
                    failUrl: window.location.origin + "/order/fail",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    customerMobilePhone: "01012341234"
                });
            });
        })();
    </script>
</div>

</body>

</html>