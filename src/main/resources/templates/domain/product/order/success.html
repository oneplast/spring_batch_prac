<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png"/>
    <link rel="stylesheet" type="text/css" href="style.css"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>토스 페이먼츠 샘플 프로젝트</title>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>

<div class="result wrapper">
    <div class="box_section">
        <h2 style="padding: 20px 0 10px 0">
            <img width="35px" src="https://static.toss.im/3d-emojis/u1F389_apng.png"/>결제 성공
        </h2>

        <p id="paymentKey"></p>
        <p id="orderId"></p>
        <p id="amount"></p>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);

    async function confirm() {
        var requestData = {
            paymentKey: urlParams.get("paymentKey"),
            orderId: urlParams.get("orderId"),
            amount: urlParams.get("amount"),
        };

        const csrfTokenHeaderName = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
        const csrfTokenValue = document.querySelector("meta[name='_csrf']").getAttribute("content");

        const response = await fetch("/order/confirm", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfTokenHeaderName]: csrfTokenValue
            },
            body: JSON.stringify(requestData),
        });

        const json = await response.json();

        if (!response.ok) {
            console.log(json);
            location.replace(`/order/fail?message=${json.message}&code=${json.code}`);

            return;
        }

        const id = urlParams.get("orderId").split("__")[1];

        location.replace(`/order/${id}?msg=결제가 완료되었습니다.`)
    }

    confirm();

    const paymentKeyElement = document.getElementById("paymentKey");
    const orderIdElement = document.getElementById("orderId");
    const amountElement = document.getElementById("amount");

    orderIdElement.textContent = "주문번호: " + urlParams.get("orderId");
    amountElement.textContent = "결제금액: " + urlParams.get("amount");
    paymentKeyElement.textContent = "paymentKey: " + urlParams.get("paymentKey");
</script>

</body>

</html>